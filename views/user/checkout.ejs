<%- include("../partials/header.ejs") %>

<section class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h2 class="text-2xl sm:text-3xl font-light mb-6 uppercase tracking-wider">Checkout</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <div class="bg-white shadow-sm rounded-lg p-6">
      <h3 class="text-lg font-medium mb-4">Order Summary</h3>
      <% cart.forEach(item => { %>
      <div class="flex items-center space-x-4 border-b pb-4 mb-4">
        <img src="<%= item.productId.productImage[0] %>" alt="<%= item.productId.productName %>" class="h-20 w-20 object-cover rounded-md">
        <div>
          <h4 class="font-medium text-gray-900"><%= item.productId.productName %></h4>
          <p class="text-sm text-gray-600">Quantity: <%= item.quantity %></p>
          <p class="text-sm text-gray-900">Price: ₹<%= item.productId.salePrice.toFixed(2) %></p>
          <p class="text-sm text-gray-900 font-semibold">Subtotal: ₹<%= (item.productId.salePrice * item.quantity).toFixed(2) %></p>
        </div>
      </div>
      <% }) %>
      <div class="flex justify-between items-center text-lg font-medium">
        <span>Total:</span>
        <span>₹<%= total.toFixed(2) %></span>
      </div>
    </div>


    <div class="bg-white shadow-sm rounded-lg p-6">
      <h3 class="text-lg font-medium mb-4">Shipping Address</h3>

    
      <label for="saved-addresses" class="block mb-2 text-sm text-gray-700">Select Saved Address</label>
      <div class="space-y-4 mb-4" id="saved-addresses-container">
        <% savedAddresses.forEach(address => { %>
          <div class="flex items-center space-x-4 border p-4 rounded-md hover:bg-gray-100 cursor-pointer">
            <input type="radio" name="savedaddress" value="<%= address._id %>" class="h-5 w-5">
            <div>
              <p class="font-medium text-gray-900"><%= address.name %></p>
              <p class="text-sm text-gray-600"><%= address.street %>, <%= address.apartment ? address.apartment + ', ' : '' %><%= address.city %>, <%= address.postalCode %></p>
              <p class="text-sm text-gray-600">Phone: <%= address.phone %></p>
            </div>
          </div>
        <% }) %>
      </div>


      <button id="add-new-address-btn" class="mt-4 w-full bg-blue-500 text-white py-3 rounded-md uppercase tracking-wide hover:bg-blue-600 transition-colors">Add New Address</button>
      <div id="new-address-form-checkout" class="mt-6 hidden">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Enter New Address for Checkout</h4>
        <div class="space-y-2">
          <input type="text" id="new-address-name" placeholder="Name" class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md">
          <input type="text" id="new-address-phone" placeholder="Phone" class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md">
          <input type="text" id="new-address-street" placeholder="Street" class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md">
          <input type="text" id="new-address-apartment" placeholder="Apartment " class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md">
          <input type="text" id="new-address-landmark" placeholder="Landmark (Optional)" class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md">
          <input type="text" id="new-address-city" placeholder="City" class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md">
          <input type="text" id="new-address-postalCode" placeholder="Postal Code" class="w-full mb-2 px-3 py-2 border border-gray-300 rounded-md">

          <div class="flex items-center mb-4">
            <input type="radio" id="new-address-home" name="addressType" value="Home" checked class="mr-2">
            <label for="new-address-home">Home</label>
            <input type="radio" id="new-address-office" name="addressType" value="Office" class="ml-4 mr-2">
            <label for="new-address-office">Office</label>
          </div>

          <button type="button" id="submit-new-address-checkout" class="bg-blue-500 text-white px-4 py-2 rounded-md">Add Address</button>
        </div>
      </div>

      <h3 class="text-lg font-medium mb-4">Payment Options</h3>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="radio" name="payment-method" value="cash" class="mr-2">
          Cash on Delivery
        </label>
        <label class="flex items-center">
          <input type="radio" name="payment-method" value="online-payment" class="mr-2">
          Online Payment
        </label>
      </div>

   
      <button id="place-order-btn" class="mt-6 w-full bg-black text-white py-3 rounded-md uppercase tracking-wide hover:bg-gray-800 transition-colors">Place Order</button>
    </div>
  </div>
</section>

<%- include("../partials/footer.ejs") %>

<script>
  document.getElementById('add-new-address-btn').addEventListener('click', () => {
    const newAddressForm = document.getElementById('new-address-form-checkout');
    newAddressForm.classList.toggle('hidden');
  });

  document.getElementById('submit-new-address-checkout').addEventListener('click', () => {
    const newAddress = {
      addressType: document.querySelector('input[name="addressType"]:checked').value,
      name: document.getElementById('new-address-name').value,
      phone: document.getElementById('new-address-phone').value,
      street: document.getElementById('new-address-street').value,
      apartment: document.getElementById('new-address-apartment').value || '',
      landmark: document.getElementById('new-address-landmark').value || '',
      city: document.getElementById('new-address-city').value,
      postalCode: document.getElementById('new-address-postalCode').value
    };

  
    if (!newAddress.name || !newAddress.phone || !newAddress.street || !newAddress.city || !newAddress.postalCode) {
      alert('Please fill in all required fields.');
      return;
    }

  
    fetch('/add-address-checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newAddress)
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {

        console.log(data)
        if (data.success) {
        
          const addressList = document.getElementById('saved-addresses-container');
          const newAddressCard = document.createElement('div');
          newAddressCard.classList.add('flex', 'items-center', 'space-x-4', 'border', 'p-4', 'rounded-md', 'hover:bg-gray-100');
          newAddressCard.innerHTML = `
            <input type="radio" name="saved-address" value="${data.address._id}" class="h-5 w-5" checked>
            <div>
              <p class="font-medium text-gray-900">${data.address.name}</p>
              <p class="text-sm text-gray-600">${data.address.street}, ${data.address.city}, ${data.address.postalCode}</p>
              <p class="text-sm text-gray-600">Phone: ${data.address.phone}</p>
            </div>
          `;

        
          addressList.prepend(newAddressCard);
          window.location.reload()
         
          document.getElementById('new-address-form-checkout').classList.add('hidden');
        } else {
          alert('Failed to add address: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error adding address:', error);
        alert('An error occurred while adding the address.');
      });
  });



</script>


<script>

   const savedAddresses = <%- JSON.stringify(savedAddresses || []) %>;
  

   document.getElementById('place-order-btn').addEventListener('click', () => {
    const selectedAddress = document.querySelector('input[name="savedaddress"]:checked')?.value;
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value;

    if (!selectedAddress) {
        alert('Please select an address.');
        return;
    }

    if (!paymentMethod) {
        alert('Please select a payment method.');
        return;
    }

    const orderDetails = {
    savedaddress: selectedAddress,
    paymentMethod,
    cart: <%- JSON.stringify(cart || []) %>, 
};

    fetch('/place-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderDetails),
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
              
                window.location.href = `/orderconfirm/${data.orderId}`;
            } else {
                alert(data.message || 'Failed to place order.');
            }
        })
        .catch(error => {
            console.error('Error placing order:', error);
            alert('An error occurred while placing the order.');
        });
});
</script>

